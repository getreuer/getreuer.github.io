<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="author" content="Pascal Getreuer, 2022-12-29" />
  <title>QMK: Repeat Key</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
<link rel="stylesheet" href="../../../site.css" type="text/css" />
<link rel="icon" href="../../../favicon.ico" type="image/x-icon" />
<link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC" rel="stylesheet" />
<script type="text/javascript" src="../../../site.js" ></script>
</head>
<body>
<div id="navbar">
<div id="navhold">
  <a href="../../../index.html">Home</a>
  <a href="../../../papers/index.html">Papers</a>
  <a href="../../../posts/index.html">Posts</a>
</div>
</div>
<div id="content">
<div id="header">
<h1 class="title">QMK: Repeat Key</h1>
<h2 class="author">Pascal Getreuer, 2022-12-29</h2>
</div>
<div id="TOC">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#add-it-to-your-keymap">Add it to your keymap</a>
<ul>
<li><a href="#repeat-using-a-combo">Repeat using a Combo</a></li>
<li><a href="#handle-how-a-key-is-repeated">Handle how a key is
repeated</a></li>
</ul></li>
<li><a href="#alternative-implementations">Alternative
implementations</a></li>
<li><a href="#reverse-repeat-key">Reverse Repeat Key</a>
<ul>
<li><a href="#handling-unmatched-keys">Handling unmatched keys</a></li>
</ul></li>
<li><a href="#customization">Customization</a>
<ul>
<li><a href="#functions">Functions</a></li>
<li><a href="#ignoring-certain-keys">Ignoring certain keys</a></li>
</ul></li>
<li><a href="#implementation-details">Implementation details</a>
<ul>
<li><a href="#tracking-the-last-key">Tracking the last key</a></li>
<li><a href="#repeat-key">Repeat Key</a></li>
<li><a href="#reverse-repeat-key-1">Reverse Repeat Key</a></li>
</ul></li>
</ul>
</div>
<p><a href="../index.html">‚Üê More about keyboards</a></p>
<div style="margin:2.2em; margin-bottom:1em">
<p><em>‚ÄúExperience isn‚Äôt interesting until it begins to repeat itself.
In fact, till it does that, it hardly is experience.‚Äù ‚Äî Elizabeth
Bowen</em></p>
</div>
<h2 id="overview">Overview</h2>
<p>This post describes an extensible ‚Äúrepeat last key‚Äù implementation.
Repeat Key performs the action of the last pressed key. For instance,
tapping the Repeat Key after tapping the <kbd>Z</kbd> key types another
‚Äú<code>z</code>.‚Äù</p>
<p>A big interest in keyboard layout design is reduction of ‚Äúsame-finger
bigrams‚Äù or SFBs, 2-letter patterns where the same finger is used to
type successive keys. The finger motions to type SFBs tend to be slow
and awkward. Doubled letters like the <code>z</code> in
‚Äú<code>dazzle</code>‚Äù are essentially SFBs as well when typed
conventionally by double tapping. The Repeat Key breaks up these double
taps, e.g.¬†rolling from <kbd>Z</kbd> to <kbd>Repeat</kbd>, which is
potentially faster and more comfortable. <a
href="https://notgate.github.io/layout/">As described by
NotGate</a>:</p>
<blockquote>
<p>The repeat key fits the theme of reducing SFBs by as much as possible
and has the bonus of including the 10th finger. Words like follow become
‚Äòfol[rep]ow‚Äô so your flow is never broken by the speed of a single
finger. It might seem overkill but you quickly get used to it and it‚Äôs
great for keeping a steady pace. There are actually far more double
letters than SFBs in typing, so technically this matters more for
preserving flow than the layout‚Äôs SFB minimization üôÉ.</p>
</blockquote>
<p>The implementation is a generic event-plumbing strategy that
interoperates predictably with most QMK features, including tap-hold
keys, Auto Shift, Combos, and userspace macros.</p>
<h2 id="add-it-to-your-keymap">Add it to your keymap</h2>
<p>If you are new to QMK macros, see my <a
href="../macros/index.html">macro buttons</a> post for an intro.</p>
<p><strong>Step 1:</strong> In your <code>keymap.c</code>, add a custom
keycode for the Repeat Key and use the new keycode in your layout. I‚Äôll
name it <code>REPEAT</code>, but you can call it anything you like.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> custom_keycodes <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  REPEAT <span class="op">=</span> SAFE_RANGE<span class="op">,</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Other custom keys...</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>A suggestion thanks to NotGate is to put <code>REPEAT</code> where
Right Alt would be on a traditional keyboard or on a key pressed by the
thumb that doesn‚Äôt press Space.</p>
<figure>
<img src="repeat-layout.png" alt="Suggested placement of Repeat Key." />
<figcaption aria-hidden="true">Suggested placement of Repeat
Key.</figcaption>
</figure>
<p><strong>Step 2:</strong> Handle Repeat Key from your
<code>process_record_user()</code> function by calling
<code>process_repeat_key()</code>, passing your custom keycode as the
third argument:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;features/repeat_key.h&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_record_user<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>process_repeat_key<span class="op">(</span>keycode<span class="op">,</span> record<span class="op">,</span> REPEAT<span class="op">))</span> <span class="op">{</span> <span class="cf">return</span> false<span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Your macros ...</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If your <code>process_record_user()</code> has other handlers or
macros, Repeat Key‚Äôs handler <code>process_repeat_key()</code> should
preferably be called before anything else. (If you also use <a
href="../achordion/index.html">Achordion</a>, then call Achordion‚Äôs
handler first, Repeat Key‚Äôs handler second, and then other
handlers.)</p>
<p><strong>Step 3:</strong> In your <code>rules.mk</code> file, add</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode mk"><code class="sourceCode makefile"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">SRC </span><span class="ch">+=</span><span class="st"> features/repeat_key.c</span></span></code></pre></div>
<p><strong>Step 4:</strong> In the directory containing your
<code>keymap.c</code>, create a <code>features</code> subdirectory and
copy <a
href="https://github.com/getreuer/qmk-keymap/blob/main/features/repeat_key.h">repeat_key.h</a>
and <a
href="https://github.com/getreuer/qmk-keymap/blob/main/features/repeat_key.c">repeat_key.c</a>
there.</p>
<p>With the above flashed to your keyboard, Repeat Key is now ready to
use. To test, tap the <kbd>Z</kbd> key and then tap the
<kbd>Repeat</kbd> key a few times. This should produce
‚Äú<code>zzzz</code>.‚Äù</p>
<p>Repeat Key remembers modifiers that were active with the last key
press. These modifiers are combined with any additional modifiers while
pressing the Repeat Key. If the last press key was <kbd>Ctrl</kbd> +
<kbd>Z</kbd>, then <kbd>Shift</kbd> + <kbd>Repeat</kbd> performs Ctrl +
Shift + <code>Z</code>.</p>
<h3 id="repeat-using-a-combo">Repeat using a Combo</h3>
<p>Instead of dedicating a key for Repeat, you might want to trigger it
<a href="https://docs.qmk.fm/#/feature_combo">with a Combo</a>. This can
be done by adding <code>COMBO_ENABLE = yes</code> in rules.mk and
defining a combo in keymap.c like</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Period + Backspace =&gt; Repeat.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">uint16_t</span> repeat_combo<span class="op">[]</span> PROGMEM <span class="op">=</span> <span class="op">{</span>KC_DOT<span class="op">,</span> KC_BSPC<span class="op">,</span> COMBO_END<span class="op">};</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>combo_t key_combos<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    COMBO<span class="op">(</span>repeat_combo<span class="op">,</span> REPEAT<span class="op">),</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="dt">uint16_t</span> COMBO_LEN <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>key_combos<span class="op">)</span> <span class="op">/</span> <span class="kw">sizeof</span><span class="op">(*</span>key_combos<span class="op">);</span></span></code></pre></div>
<h3 id="handle-how-a-key-is-repeated">Handle how a key is repeated</h3>
<p>By default, pressing <kbd>Repeat</kbd> will simply behave as if the
last key were pressed again. This also works with macro keys with custom
handlers, invoking the macro again. In case fine-tuning is needed for
sensible repetition, you can handle how a key is repeated with
<code>repeat_key_count()</code> within
<code>process_record_user()</code>.</p>
<p>When a key is pressed as usual, <code>repeat_key_count()</code> is 0.
On the first repeat, it is 1, then the second repeat, 2, and so on. For
instance supposing <code>MY_MACRO</code> is a custom keycode used in the
layout:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_record_user<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>process_repeat_key<span class="op">(</span>keycode<span class="op">,</span> record<span class="op">,</span> REPEAT<span class="op">))</span> <span class="op">{</span> <span class="cf">return</span> false<span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>keycode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> MY_MACRO<span class="op">:</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>repeat_key_count<span class="op">()</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span>  <span class="co">// MY_MACRO is being repeated!</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>record<span class="op">-&gt;</span>event<span class="op">.</span>pressed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>          SEND_STRING<span class="op">(</span><span class="st">&quot;repeat!&quot;</span><span class="op">);</span>    </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>                       <span class="co">// MY_MACRO is being used normally.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>record<span class="op">-&gt;</span>event<span class="op">.</span>pressed<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>          SEND_STRING<span class="op">(</span><span class="st">&quot;macro&quot;</span><span class="op">);</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Other macros...</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="alternative-implementations">Alternative implementations</h2>
<p>I‚Äôm aware of a few existing ‚Äúrepeat last key‚Äù implementations:</p>
<ul>
<li><p><a href="https://github.com/jtroo/kanata">Kanata</a> is a
software key remapper for Windows and Linux with a <a
href="https://github.com/jtroo/kanata/blob/main/docs/config.adoc#repeat-key">repeat
key feature</a>, among many other features.</p></li>
<li><p>With AutoHotkey, <a
href="https://gist.github.com/NotGate/74a5993307424ddb5c9edb87b6280728">NotGate‚Äôs
script</a> implements repeat based on <code>A_PriorKey</code>.</p></li>
<li><p>With ZMK firmware, <a
href="https://zmk.dev/docs/behaviors/key-repeat">repeat is a core
feature</a>.</p></li>
<li><p>With QMK firmware, there are</p>
<ul>
<li><a
href="https://github.com/treeman/qmk_firmware/blob/b0dc8324daad99f29fe1d7555917b2a169f68f97/keyboards/ferris/keymaps/treeman/repeat.c">Jonas
Hietala‚Äôs repeat key</a> (also reverse repeat key)</li>
<li><a
href="https://gist.github.com/NotGate/3e3d8ab81300a86522b2c2549f99b131?permalink_comment_id=3732369#gistcomment-3732369">Precondition‚Äôs
repeat key</a>, with contributions from <span class="citation"
data-cites="Apsu">@Apsu</span> and <span class="citation"
data-cites="KapJI">@KapJI</span></li>
</ul></li>
</ul>
<h2 id="reverse-repeat-key">Reverse Repeat Key</h2>
<p>An idea thanks to Jonas Hietala is a complementary ‚ÄúReverse Repeat
Key.‚Äù For instance, when the last key is Page Down, the Reverse Repeat
Key performs Page Up. The utility of Reverse Repeat is limited, to be
frank, since only some keys have a clear-cut correspondence to keys with
the opposing action. Yet it is satisfying when it comes to use.</p>
<p>Do the following to use the Reverse Repeat Key in your keymap.c:</p>
<ol type="1">
<li><p>Add a custom keycode for Reverse Repeat, say <code>REVREP</code>,
and use it in your layout.</p></li>
<li><p>In <code>process_record_user()</code>, handle Repeat and Reverse
Repeat as</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>process_repeat_key_with_rev<span class="op">(</span>keycode<span class="op">,</span> record<span class="op">,</span> REPEAT<span class="op">,</span> REVREP<span class="op">))</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>Copy the following into keymap.c:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">uint16_t</span> rev_repeat_key_pairs<span class="op">[][</span><span class="dv">2</span><span class="op">]</span> PROGMEM <span class="op">=</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_LEFT<span class="op">,</span> KC_RGHT<span class="op">},</span>             <span class="co">// Left / Right Arrow.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_UP  <span class="op">,</span> KC_DOWN<span class="op">},</span>             <span class="co">// Up / Down Arrow.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>S<span class="op">(</span>KC_LEFT<span class="op">),</span> S<span class="op">(</span>KC_RGHT<span class="op">)},</span>       <span class="co">// Shift + Left / Right Arrow.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>S<span class="op">(</span>KC_UP<span class="op">),</span> S<span class="op">(</span>KC_DOWN<span class="op">)},</span>         <span class="co">// Shift + Up / Down Arrow.</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>C<span class="op">(</span>KC_LEFT<span class="op">),</span> C<span class="op">(</span>KC_RGHT<span class="op">)},</span>       <span class="co">// Ctrl + Left / Right Arrow.</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>C<span class="op">(</span>S<span class="op">(</span>KC_LEFT<span class="op">)),</span> C<span class="op">(</span>S<span class="op">(</span>KC_RGHT<span class="op">))},</span> <span class="co">// Ctrl + Shift + Left / Right Arrow.</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_HOME<span class="op">,</span> KC_END <span class="op">},</span>             <span class="co">// Home / End.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_PGUP<span class="op">,</span> KC_PGDN<span class="op">},</span>             <span class="co">// Page Up / Page Down.</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>C<span class="op">(</span>KC_PGUP<span class="op">),</span> C<span class="op">(</span>KC_PGDN<span class="op">)},</span>       <span class="co">// Ctrl + Page Up / Page Down.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_TAB <span class="op">,</span> S<span class="op">(</span>KC_TAB<span class="op">)},</span>           <span class="co">// Tab / Shift + Tab.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_WBAK<span class="op">,</span> KC_WFWD<span class="op">},</span>             <span class="co">// Browser Back / Forward.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_MNXT<span class="op">,</span> KC_MPRV<span class="op">},</span>             <span class="co">// Next / Previous Media Track.</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_MFFD<span class="op">,</span> KC_MRWD<span class="op">},</span>             <span class="co">// Fast Forward / Rewind Media.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_VOLU<span class="op">,</span> KC_VOLD<span class="op">},</span>             <span class="co">// Volume Up / Down.</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_BRIU<span class="op">,</span> KC_BRID<span class="op">},</span>             <span class="co">// Brightness Up / Down.</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Navigation hotkeys in Vim, Emacs, and other programs.</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_H   <span class="op">,</span> KC_L   <span class="op">},</span>             <span class="co">// Left / Right.</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_J   <span class="op">,</span> KC_K   <span class="op">},</span>             <span class="co">// Down / Up.</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_W   <span class="op">,</span> KC_B   <span class="op">},</span>             <span class="co">// Forward / Backward by word.</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>C<span class="op">(</span>KC_N<span class="op">),</span> C<span class="op">(</span>KC_P<span class="op">)},</span>             <span class="co">// Next / Previous.</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>C<span class="op">(</span>KC_D<span class="op">),</span> C<span class="op">(</span>KC_U<span class="op">)},</span>             <span class="co">// Down / Up.</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>C<span class="op">(</span>KC_F<span class="op">),</span> C<span class="op">(</span>KC_B<span class="op">)},</span>             <span class="co">// Forward / Backward.</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>A<span class="op">(</span>KC_F<span class="op">),</span> A<span class="op">(</span>KC_B<span class="op">)},</span>             <span class="co">// Forward / Backward by word.</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Mouse keys (if enabled).</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef MOUSEKEY_ENABLE</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_MS_L<span class="op">,</span> KC_MS_R<span class="op">},</span>             <span class="co">// Mouse Cursor Left / Right.</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_MS_U<span class="op">,</span> KC_MS_D<span class="op">},</span>             <span class="co">// Mouse Cursor Up / Down.</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_WH_L<span class="op">,</span> KC_WH_R<span class="op">},</span>             <span class="co">// Mouse Wheel Left / Right.</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KC_WH_U<span class="op">,</span> KC_WH_D<span class="op">},</span>             <span class="co">// Mouse Wheel Up / Down.</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>S<span class="op">(</span>KC_WH_U<span class="op">),</span> S<span class="op">(</span>KC_WH_D<span class="op">)},</span>       <span class="co">// Shift + Mouse Wheel Up / Down.</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>C<span class="op">(</span>KC_WH_U<span class="op">),</span> C<span class="op">(</span>KC_WH_D<span class="op">)},</span>       <span class="co">// Ctrl + Mouse Wheel Up / Down.</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif  </span><span class="co">// MOUSEKEY_ENABLE</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Lighting keys (if enabled).</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef BACKLIGHT_ENABLE</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>BL_UP  <span class="op">,</span> BL_DOWN<span class="op">},</span>             <span class="co">// Increase / decrease backlight.</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif  </span><span class="co">// BACKLIGHT_ENABLE</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined(RGBLIGHT_ENABLE) || defined(RGB_MATRIX_ENABLE)</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>RGB_MOD<span class="op">,</span> RGB_RMOD<span class="op">},</span>            <span class="co">// Effect mode forward / backward.</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>RGB_HUI<span class="op">,</span> RGB_HUD<span class="op">},</span>             <span class="co">// Increase / decrease hue.</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>RGB_SAI<span class="op">,</span> RGB_SAD<span class="op">},</span>             <span class="co">// Increase / decrease saturation.</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>RGB_VAI<span class="op">,</span> RGB_VAD<span class="op">},</span>             <span class="co">// Increase / decrease value.</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>RGB_SPI<span class="op">,</span> RGB_SPD<span class="op">},</span>             <span class="co">// Increase / decrease effect speed.</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif  </span><span class="co">// defined(RGBLIGHT_ENABLE) || defined(RGB_MATRIX_ENABLE)</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">uint16_t</span> NUM_REV_REPEAT_KEY_PAIRS <span class="op">=</span> </span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>  <span class="kw">sizeof</span><span class="op">(</span>rev_repeat_key_pairs<span class="op">)</span> <span class="op">/</span> <span class="kw">sizeof</span><span class="op">(*</span>rev_repeat_key_pairs<span class="op">);</span></span></code></pre></div></li>
</ol>
<p>Reverse Repeat considers pairs of keys defined in
<code>rev_repeat_key_pairs</code>. When Reverse Repeat is used, it
searches the table for an entry containing
<code>repeat_key_keycode()</code>, then performs the other keycode in
the pair. The definition above is a suggestion; edit to customize the
Reverse Repeat Key for your purposes.</p>
<p>When <code>repeat_key_keycode()</code> is a basic keycode,
<code>repeat_key_mods()</code> is considered in the lookup as well so
that for instance <code>B</code> is distinct from Ctrl + <code>B</code>.
Handedness of mods is ignored except for Right Alt (AltGr).</p>
<h3 id="handling-unmatched-keys">Handling unmatched keys</h3>
<p>If no match is found in the <code>rev_repeat_key_pairs</code> table,
Reverse Repeat does nothing by default. Optionally, handling for
unmatched keys may be implemented in <code>process_record_user()</code>.
In the following, supposing a custom keycode <code>UPDIR</code> has been
defined. Pressing <kbd>UPDIR</kbd> types ‚Äú<code>../</code>,‚Äù and then
pressing <kbd>REVREP</kbd> taps Backspace three times to reverse it:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_record_user<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>process_repeat_key_with_rev<span class="op">(</span>keycode<span class="op">,</span> record<span class="op">,</span> REPEAT<span class="op">,</span> REVREP<span class="op">))</span> <span class="op">{</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>keycode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> REVREP<span class="op">:</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// REVREP is being used, but didn&#39;t match, and repeat_key_keycode()</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// is the key being reversed.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">switch</span> <span class="op">(</span>repeat_key_keycode<span class="op">())</span> <span class="op">{</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> UPDIR<span class="op">:</span>  <span class="co">// Perform the reverse of UPDIR...</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>record<span class="op">-&gt;</span>event<span class="op">.</span>pressed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            tap_code<span class="op">(</span>KC_BSPC<span class="op">);</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            tap_code<span class="op">(</span>KC_BSPC<span class="op">);</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            tap_code<span class="op">(</span>KC_BSPC<span class="op">);</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> UPDIR<span class="op">:</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>record<span class="op">-&gt;</span>event<span class="op">.</span>pressed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        SEND_STRING<span class="op">(</span><span class="st">&quot;../&quot;</span><span class="op">);</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Other macros ...</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="customization">Customization</h2>
<h3 id="functions">Functions</h3>
<table>
<colgroup>
<col style="width: 41%" />
<col style="width: 58%" />
</colgroup>
<thead>
<tr class="header">
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>repeat_key_register()</code></td>
<td>Press down the Repeat Key.</td>
</tr>
<tr class="even">
<td><code>repeat_key_unregister()</code></td>
<td>Release the Repeat Key.</td>
</tr>
<tr class="odd">
<td><code>repeat_key_tap()</code></td>
<td>Tap the Repeat Key.</td>
</tr>
<tr class="even">
<td><code>repeat_key_count()</code></td>
<td>How many times the current key has been repeated: 0 ‚áí key is pressed
normally, 1 ‚áí first repeat, 2 ‚áí second repeat, etc.</td>
</tr>
<tr class="odd">
<td><code>repeat_key_keycode()</code></td>
<td>The last keycode, the key to be repeated.</td>
</tr>
<tr class="even">
<td><code>repeat_key_mods()</code></td>
<td>Modifiers to apply when repeating.</td>
</tr>
</tbody>
</table>
<p>There are a few analogous functions for the Reverse Repeat Key:</p>
<div class="eqscroll">
<table>
<colgroup>
<col style="width: 41%" />
<col style="width: 58%" />
</colgroup>
<thead>
<tr class="header">
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>rev_repeat_key_register()</code></td>
<td>Press down the Reverse Repeat Key.</td>
</tr>
<tr class="even">
<td><code>rev_repeat_key_unregister()</code></td>
<td>Release the Reverse Repeat Key.</td>
</tr>
<tr class="odd">
<td><code>rev_repeat_key_tap()</code></td>
<td>Tap the Reverse Repeat Key.</td>
</tr>
<tr class="even">
<td><code>rev_repeat_key_keycode()</code></td>
<td>Keycode for Reverse Repeat found from
<code>rev_repeat_key_pairs</code>, or <code>KC_NO</code> if not
found.</td>
</tr>
</tbody>
</table>
</div>
<p>The <code>repeat_key_register()</code>,
<code>repeat_key_unregister()</code>, and <code>repeat_key_tap()</code>
functions and corresponding functions for Reverse Repeat Key are useful
for invoking Repeat and Reverse Repeat Key from an encoder, leader key
sequence, or other custom handler. Note that if doing so, you likely
want to define <code>repeat_key_press_user()</code> as described below
to ignore the keycode associated with that handler so that the Repeat
Key does not attempt to repeat or reverse-repeat itself.</p>
<h3 id="ignoring-certain-keys">Ignoring certain keys</h3>
<p>By default, the Repeat Key ignores modifier and layer switch keys in
tracking what the ‚Äúlast‚Äù key was. This enables possibly setting some
mods and changing layers between pressing a key and repeating it. To
customize which keys are ignored, define
<code>repeat_key_press_user()</code> in your keymap.c. The default
implementation is</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> repeat_key_press_user<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>keycode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ignore MO, TO, TG, and TT layer switch keys.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_MOMENTARY <span class="op">...</span> QK_MOMENTARY_MAX<span class="op">:</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_TO <span class="op">...</span> QK_TO_MAX<span class="op">:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_TOGGLE_LAYER <span class="op">...</span> QK_TOGGLE_LAYER_MAX<span class="op">:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_LAYER_TAP_TOGGLE <span class="op">...</span> QK_LAYER_TAP_TOGGLE_MAX<span class="op">:</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ignore mod keys.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> KC_LCTL <span class="op">...</span> KC_RGUI<span class="op">:</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> KC_HYPR<span class="op">:</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> KC_MEH<span class="op">:</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ignore one-shot keys.</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef NO_ACTION_ONESHOT</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_ONE_SHOT_LAYER <span class="op">...</span> QK_ONE_SHOT_LAYER_MAX<span class="op">:</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_ONE_SHOT_MOD <span class="op">...</span> QK_ONE_SHOT_MOD_MAX<span class="op">:</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif  </span><span class="co">// NO_ACTION_ONESHOT</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ignore hold events on tap-hold keys.</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef NO_ACTION_TAPPING</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_MOD_TAP <span class="op">...</span> QK_MOD_TAP_MAX<span class="op">:</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef NO_ACTION_LAYER</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_LAYER_TAP <span class="op">...</span> QK_LAYER_TAP_MAX<span class="op">:</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif  </span><span class="co">// NO_ACTION_LAYER</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>record<span class="op">-&gt;</span>tap<span class="op">.</span>count <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif  </span><span class="co">// NO_ACTION_TAPPING</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef SWAP_HANDS_ENABLE</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QK_SWAP_HANDS <span class="op">...</span> QK_SWAP_HANDS_MAX<span class="op">:</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>keycode <span class="op">&gt;</span> <span class="bn">0x56f0</span> <span class="op">||</span> record<span class="op">-&gt;</span>tap<span class="op">.</span>count <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif  </span><span class="co">// SWAP_HANDS_ENABLE</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This callback is called on every key press. Returning true indicates
the key is eligible for repeating, while false means it is ignored.</p>
<h2 id="implementation-details">Implementation details</h2>
<p>If you are interested in the technical details, this section is an
explanation of how Repeat Key and Reverse Repeat Key are
implemented.</p>
<h3 id="tracking-the-last-key">Tracking the last key</h3>
<p>On every key press event, <code>repeat_key_press_user()</code> is
called to check whether that key is eligible for repeating. If so, the
keycode, <code>keyrecord_t</code> record, layer state, and modifiers
state are all stored. The value of <code>repeat_key_count()</code> is
reset to zero to indicate to subsequent handlers that the key is being
pressed normally.</p>
<h3 id="repeat-key">Repeat Key</h3>
<p>When the Repeat Key is pressed or released, we synthesize a new event
on the last key using the stored variables. This is done by preparing
the record and passing it back into the event pipeline:</p>
<ol type="1">
<li><p>The stored modifiers and layer state are recalled and applied.
The event pipeline will look up the keycode based on record‚Äôs matrix key
position and the current layer state, so temporarily switching back to
the last layer state is needed to engage the intended key.</p></li>
<li><p>If the event is a repeat, we increment the value of
<code>repeat_key_count()</code>.</p></li>
<li><p>We set the <code>record.event.pressed</code> and
<code>record.event.time</code> fields for the new event, then pass it
into the event pipeline by calling <code>process_record()</code> to
process it. However, as the Repeat Key handler is itself a part the
event pipeline, a complication is that this call may recurse back into
the Repeat Key handler. To avoid the possibility for an infinite loop, a
boolean is set <code>recursing = true</code> while calling
<code>process_record()</code> and have the handler return early when
this boolean is set.</p></li>
<li><p>When <code>process_record()</code> returns, the modifiers and
layer state are restored.</p></li>
</ol>
<h3 id="reverse-repeat-key-1">Reverse Repeat Key</h3>
<p>The Reverse Repeat Key is implemented by looking in the
<code>rev_repeat_key_pairs</code> table for a pair containing the last
keycode <code>repeat_key_keycode()</code>. The other keycode in the pair
is used to perform the ‚Äúreverse‚Äù action by calling
<code>register_code16()</code> and <code>unregister_code16()</code> on
it.</p>
<p>When the last keycode isn‚Äôt found in the table, the Reverse Repeat
Key handler returns true so that execution continues into
<code>process_record_user()</code>. There, the user can handle the event
by checking for <code>keycode == REVREP</code>, and
<code>repeat_key_keycode()</code> is the unmatched keycode being
reversed.</p>
<p><a href="../index.html">‚Üê More about keyboards</a></p>
</div>

<div id="footer">
<p style="text-align:right">
<a href="https://scholar.google.com/citations?user=G8Yjd9AAAAAJ" target="_blank">Google Scholar</a>
<a href="http://www.linkedin.com/in/pascalgetreuer" target="_blank">LinkedIn</a>
</p>
</div>
</body>
</html>
