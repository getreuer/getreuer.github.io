<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="author" content="Pascal Getreuer, 2023-12-17 (updated 2025-01-11)" />
  <title>Developing QMK features</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
<link rel="stylesheet" href="../../../site.css" type="text/css" />
<link rel="icon" href="../../../favicon.ico" type="image/x-icon" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@350&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<script type="text/javascript" src="../../../site.js" ></script>
</head>
<body>
<div id="navbar">
<div id="navhold">
  <a href="../../../index.html">Home</a>
  <a href="../../../papers/index.html">Papers</a>
  <a href="../../../posts/index.html">Posts</a>
</div>
</div>
<div id="content">
<div id="header">
<h1 class="title">Developing QMK features</h1>
<h2 class="author">Pascal Getreuer, 2023-12-17 (updated 2025-01-11)</h2>
</div>
<div id="TOC">
<ul>
<li><a href="#overview" id="toc-overview">Overview</a>
<ul>
<li><a href="#license" id="toc-license">License</a></li>
</ul></li>
<li><a href="#userspace-features" id="toc-userspace-features">Userspace
features</a>
<ul>
<li><a href="#feature-skeleton" id="toc-feature-skeleton">Feature
skeleton</a></li>
<li><a href="#user-instructions" id="toc-user-instructions">User
instructions</a></li>
</ul></li>
<li><a href="#qmk-core-features" id="toc-qmk-core-features">QMK core
features</a>
<ul>
<li><a href="#how-to-contribute-a-core-feature"
id="toc-how-to-contribute-a-core-feature">How to contribute a core
feature</a></li>
<li><a href="#past-feature-prs" id="toc-past-feature-prs">Past feature
PRs</a></li>
</ul></li>
<li><a href="#exposing-options" id="toc-exposing-options">Exposing
options</a>
<ul>
<li><a href="#preprocessor-constants"
id="toc-preprocessor-constants">Preprocessor constants</a></li>
<li><a href="#callbacks" id="toc-callbacks">Callbacks</a></li>
<li><a href="#global-config-variable"
id="toc-global-config-variable">Global config variable</a></li>
</ul></li>
<li><a href="#diagnostics" id="toc-diagnostics">Diagnostics</a>
<ul>
<li><a href="#debug-console" id="toc-debug-console">Debug
console</a></li>
<li><a href="#alternative-typing-out-debug-messages"
id="toc-alternative-typing-out-debug-messages">Alternative: typing out
debug messages</a></li>
<li><a href="#logging-keycodes" id="toc-logging-keycodes">Logging
keycodes</a></li>
<li><a href="#corresponding-physical-keys-to-matrix-positions"
id="toc-corresponding-physical-keys-to-matrix-positions">Corresponding
physical keys to matrix positions</a></li>
</ul></li>
<li><a href="#closing" id="toc-closing">Closing</a></li>
</ul>
</div>
<p><a href="../index.html">← More about keyboards</a></p>
<h2 id="overview">Overview</h2>
<p>The QMK features on this site are “userspace feature libraries,” C
libraries for adding some behavior to a keymap. <a
href="../custom-shift-keys/index.html">Custom shift keys</a> and <a
href="../achordion/index.html">Achordion</a> are examples. The point of
wrapping up a feature as a library is to make it reusable across
different keymaps and to encapsulate implementation details so as to
avoid cluttering the keymap. A few of these features have also been
integrated into QMK itself as core features. We discuss both kinds of
feature implementations here.</p>
<h3 id="license">License</h3>
<p>Code snippets in this post are shared under Apache 2 license.</p>
<div style="font-size:85%">
<blockquote>
<p>Copyright 2023-2025 Google LLC</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”); you
may not use this file except in compliance with the License. You may
obtain a copy of the License at</p>
<p><a href="https://www.apache.org/licenses/LICENSE-2.0"
class="uri">https://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</blockquote>
</div>
<h2 id="userspace-features">Userspace features</h2>
<p>There are no strict rules about how a userspace library should be
structured, so long as it compiles. It does help to follow a few
conventions:</p>
<ul>
<li><p>If the feature processes key events, do so with a function with
the same interface as <code>process_record_user()</code>:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_cool<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">);</span></span></code></pre></div></li>
<li><p>If the feature involves running some code in
<code>housekeeping_task_user()</code> or
<code>matrix_scan_user()</code>, put that code in a “task” function:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cool_task<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code></pre></div></li>
<li><p>As is good C practice generally, work the feature name into the
naming of every publicly visible function, preprocessor option, etc. to
avoid name collisions.</p></li>
</ul>
<h3 id="feature-skeleton">Feature skeleton</h3>
<p>To get started, here is a skeleton definition for a cool feature.
Again, note that there are no strict rules about how a userspace library
is supposed to be structured. This is just my formula for it. Feel free
to adapt as you see fit.</p>
<p><strong>features/cool.h</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: Describe here...</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">// * What does this Cool feature do?</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">// * QMK features, if any, that need to enabled.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">// * Configuration options.</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma once</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;quantum.h&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Handler function for Cool feature. Call this from process_record_user().</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Args `keycode` and `record` are the current key event to handle. Returns</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">// true if default handling should continue; false if it should be skipped.</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_cool<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">);</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Task function for Cool feature. Call this from housekeeping_task_user().</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cool_task<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code></pre></div>
<p><strong>features/cool.c</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;cool.h&quot;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_cool<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Do something cool...</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cool_task<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Do something cool...</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In cool.h, <code>#pragma once</code> indicates the header should be
processed once, even if included multiple times in the same source file,
and <code>#include "quantum.h"</code> accesses QMK’s definitions and
APIs. Like the rest of QMK, feature code should target C11 and may make
use GNU extensions (see <a
href="../faqs/index.html#what-is-this-weird-c-syntax-qmk">What is this
weird C syntax</a>).</p>
<h3 id="user-instructions">User instructions</h3>
<p>Users will need to complete a few steps to use the feature in their
keymap. For the skeleton above, the steps are as follows.</p>
<p><strong>Step 1:</strong> In the user’s keymap.c, include cool.h and
call the handler and task function.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;features/cool.h&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_record_user<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> <span class="op">(!</span>process_cool<span class="op">(</span>keycode<span class="op">,</span> record<span class="op">))</span> <span class="op">{</span> <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a> <span class="co">// Other macros ...</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a> <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> housekeeping_task_user<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a> cool_task<span class="op">();</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a> <span class="co">// Other tasks...</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Step 2:</strong> In the user’s rules.mk, add</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode mk"><code class="sourceCode makefile"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">SRC</span> <span class="ch">+=</span><span class="st"> features/cool.c</span></span></code></pre></div>
<p><strong>Step 3:</strong> In the directory containing keymap.c, create
a “features” subdirectory and copy cool.h and cool.c there.</p>
<h2 id="qmk-core-features">QMK core features</h2>
<p>A QMK core feature is part of QMK itself. Examples include the items
listed under the “Advanced keycodes” and “Software features” sections of
<a href="https://docs.qmk.fm/">QMK’s documentation</a>. Implementation
of core features follows similar patterns as those described in the
previous section. For example, you can see how <a
href="https://docs.qmk.fm/features/repeat_key">Repeat Key</a> was added
as a core feature <a
href="https://github.com/qmk/qmk_firmware/pull/19700/files">in this pull
request</a>.</p>
<h3 id="how-to-contribute-a-core-feature">How to contribute a core
feature</h3>
<p>The following is an outline for how one might add a new core feature
to QMK:</p>
<ol type="1">
<li><p><strong>Discussion</strong>: Submit <a
href="https://github.com/qmk/qmk_firmware/issues">a feature request</a>
or start a thread on the <a href="https://reddit.com/r/olkb">r/olkb
subreddit</a> or <a href="https://discord.gg/Uq7gcHh">on Discord</a> to
scope out interest.</p></li>
<li><p><strong>Userspace prototype</strong>: Develop the feature
initially as a userspace library, if feasible, and share it with others.
This is a great way to experiment and get early feedback.</p></li>
<li><p><strong>Move to core</strong>: Refactor the feature as a core QMK
feature on your local copy of the qmk_firmware repo. Write documentation
(<a
href="https://github.com/qmk/qmk_firmware/tree/master/docs">docs/</a>)
and unit tests (<a
href="https://github.com/qmk/qmk_firmware/tree/master/tests">tests/</a>).
Check how the feature operates when used in combination with other
features.</p></li>
<li><p><strong>Pull request (PR)</strong>: Read <a
href="https://docs.qmk.fm/contributing">Contributing to QMK</a> and <a
href="https://docs.qmk.fm/pr_checklist">QMK’s PR checklist</a>. Submit a
PR to merge into the <code>develop</code> branch. Be patient. Review
often takes a few months.</p></li>
<li><p><strong>Release</strong>: <a
href="https://docs.qmk.fm/breaking_changes_history">Breaking
changes</a>, including any new core features, are made first on
<code>develop</code>, then released four times a year when
<code>develop</code> is merged into <code>master</code>.</p></li>
</ol>
<p>It is essential that QMK users be able to rely on their keyboards.
New core features are reviewed and accepted at a cautious pace. The full
outline above might realistically take 6–12 months depending on the
feature’s complexity and reviewer availability.</p>
<h3 id="past-feature-prs">Past feature PRs</h3>
<p>It is enormously helpful to look at the PRs for existing features to
see how things are done. An incomplete list:</p>
<ul>
<li><a href="https://github.com/qmk/qmk_firmware/pull/19700">#19700 –
Repeat Key</a></li>
<li><a href="https://github.com/qmk/qmk_firmware/pull/18463">#18463 – OS
Detection</a></li>
<li><a href="https://github.com/qmk/qmk_firmware/pull/16588">#16588 –
Caps Word</a></li>
<li><a href="https://github.com/qmk/qmk_firmware/pull/15699">#15699 –
Autocorrect</a></li>
<li><a href="https://github.com/qmk/qmk_firmware/pull/12851">#12851 –
Digitizer support</a></li>
<li><a href="https://github.com/qmk/qmk_firmware/pull/11422">#11422 –
Key Overrides</a></li>
<li><a href="https://github.com/qmk/qmk_firmware/pull/11036">#11036 –
Dynamic Tapping Term</a></li>
<li><a href="https://github.com/qmk/qmk_firmware/pull/10174">#10174 –
Quantum Painter</a></li>
</ul>
<h2 id="exposing-options">Exposing options</h2>
<p>Most features involve some options. Avoid baked-in assumptions about
the keymap’s custom keycodes, etc., which would curtail reusability.
Instead, expose options to let the user configure such things. Here are
some common patterns to do that.</p>
<h3 id="preprocessor-constants">Preprocessor constants</h3>
<p>Let the user <code>#define</code> options in their config.h:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In config.h</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define COOL_TIMEOUT_MS </span><span class="dv">5000</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">// In features/cool.c</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef COOL_TIMEOUT_MS</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Timeout logic...</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif  </span><span class="co">// COOL_TIMEOUT_MS</span></span></code></pre></div>
<p>This fits well for boolean enabled/disabled options as well as
timeouts and other numeric options. For a real example, see for instance
Caps Word’s <a
href="https://docs.qmk.fm/features/caps_word#invert-on-shift">CAPS_WORD_INVERT_ON_SHIFT</a>
(boolean) and <a
href="https://docs.qmk.fm/features/caps_word#idle-timeout">CAPS_WORD_IDLE_TIMEOUT</a>
(numeric).</p>
<p>Preprocessor options can also be used for lists of values:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In config.h</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define COOL_SEQUENCE </span><span class="op">{</span><span class="dv">3</span><span class="op">,</span><span class="pp"> </span><span class="dv">1</span><span class="op">,</span><span class="pp"> </span><span class="dv">4</span><span class="op">,</span><span class="pp"> </span><span class="dv">1</span><span class="op">,</span><span class="pp"> </span><span class="dv">5</span><span class="op">,</span><span class="pp"> </span><span class="dv">9</span><span class="op">}</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">// In features/cool.c</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint8_t</span> sequence<span class="op">[]</span> <span class="op">=</span> COOL_SEQUENCE<span class="op">;</span></span></code></pre></div>
<p>The Unicode feature’s <a
href="https://docs.qmk.fm/features/unicode#input-modes">UNICODE_SELECTED_MODES</a>
and Secure feature’s <a
href="https://docs.qmk.fm/features/secure#configuration">SECURE_UNLOCK_SEQUENCE</a>
work this way.</p>
<h3 id="callbacks">Callbacks</h3>
<p>Let the user define a callback for deeper customization:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In features/cool.h</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Defines whether Cool feature is enabled for `keycode`.</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> cool_enabled_for_key<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">// In features/cool.c</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>__attribute__<span class="op">((</span>weak<span class="op">))</span> <span class="dt">bool</span> cool_enabled_for_key<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>  <span class="co">// By default, enable for all keys.</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">// In keymap.c</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> cool_enabled_for_key<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// User&#39;s implemention, overrides the default implemention...</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>__attribute__((weak))</code> syntax in cool.c is a GNU
extension annotating the callback definition as a <a
href="https://en.wikipedia.org/wiki/Weak_symbol">weak symbol</a>. This
allows us to make a default definition of the callback that the user may
optionally override by making their own redefinition in keymap.c.</p>
<p>Callbacks are useful to customize per-key behavior, like Caps Word’s
<a
href="https://docs.qmk.fm/features/caps_word#configure-which-keys-are-word-breaking">caps_word_press_user()</a>
to define which keycodes are word breaking. Callbacks can also enable
the user to react to feature events, like Caps Word’s <a
href="https://docs.qmk.fm/features/caps_word#representing-caps-word-state">caps_word_set_user()</a>
to react to when Caps Word turns on or off.</p>
<h3 id="global-config-variable">Global config variable</h3>
<p>Have the user define configurations in a global variable:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode h"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In features/cool.h</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> cool_keycode<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> cool_layer<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> cool_config_t<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">const</span> cool_config_t cool_config<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">// In keymap.c</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> cool_config_t cool_config <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>cool_keycode <span class="op">=</span> COOL_KEY<span class="op">,</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>cool_layer <span class="op">=</span> COOL_LAYER<span class="op">,</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>For example the <a href="https://docs.qmk.fm/features/combo">Combos
feature</a> uses this pattern for its <code>combo_t key_combos[]</code>
array.</p>
<h2 id="diagnostics">Diagnostics</h2>
<p>It is a fact of engineering life that fixing bugs is an expected part
of development. This section describes methods for outputting debug
messages.</p>
<h3 id="debug-console">Debug console</h3>
<p>QMK has a <a href="https://docs.qmk.fm/faq_debug">Console feature</a>
to output debug information, which can be extremely helpful. How to use
it:</p>
<ol type="1">
<li><p>Enable it by adding in rules.mk:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode mk"><code class="sourceCode makefile"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CONSOLE_ENABLE</span> <span class="ch">=</span><span class="st"> yes</span></span></code></pre></div></li>
<li><p>Add a <code>DB_TOGG</code> key to your keymap to enable debug
mode.</p></li>
<li><p>To print your own console messages, add</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;print.h&quot;</span></span></code></pre></div>
<p>at the top of keymap.c and print formatted messages with</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dprintf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s</span><span class="st"> string&quot;</span><span class="op">,</span> var<span class="op">);</span></span></code></pre></div>
<p>Note that this API does not support all the format specifiers of
standard <code>printf()</code>. For instance, uppercase hex
<code>%04X</code> works, but lowercase <code>%04x</code> does
not.</p></li>
<li><p>Software is needed on the host computer to listen for the console
messages. Use either the <a
href="https://github.com/qmk/qmk_toolbox">QMK Toolbox</a>, the <a
href="https://docs.qmk.fm/cli_commands#qmk-console">qmk console</a>
command, or <a
href="https://docs.qmk.fm/faq_debug#debugging-with-hid-listen">hid_listen</a>.
Getting the listening software to recognize the device is finicky and
may require system configuration. See the <a
href="https://docs.qmk.fm/faq_debug">Console documentation</a> for
troubleshooting suggestions.</p></li>
<li><p>Press <code>DB_TOGG</code>. This should show a message
“<code>DEBUG: enabled</code>” and begin displaying your
<code>dprintf()</code> messages.</p></li>
</ol>
<h3 id="alternative-typing-out-debug-messages">Alternative: typing out
debug messages</h3>
<p>If you can’t (or don’t want) to use Console, a primitive alternative
is to type out messages with <code>send_string()</code>. An easy way to
do that is in combination with <code>snprintf()</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Type the HSV coordinates for the current RGB matrix color.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> buffer<span class="op">[</span><span class="dv">20</span><span class="op">];</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>snprintf<span class="op">(</span>buffer<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>buffer<span class="op">),</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;HSV: &quot;</span> PRIu8 <span class="st">&quot;, &quot;</span> PRIu8 <span class="st">&quot;, &quot;</span> PRIu8<span class="op">,</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>         rgb_matrix_get_hue<span class="op">(),</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>         rgb_matrix_get_sat<span class="op">(),</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>         rgb_matrix_get_val<span class="op">());</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>send_string<span class="op">(</span>buffer<span class="op">);</span></span></code></pre></div>
<p>Beware though that <code>snprintf()</code> (and
<code>sprintf()</code>) adds a couple kilobytes to the firmware size. If
this is a problem, use the following to cheaply type formatted
strings:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Type uint8_t value in decimal format.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>send_string<span class="op">(</span>get_u8_str<span class="op">(</span>x<span class="op">,</span> <span class="ch">&#39; &#39;</span><span class="op">));</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Type uint16_t value in decimal format.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>send_string<span class="op">(</span>get_u16_str<span class="op">(</span>y<span class="op">,</span> <span class="ch">&#39; &#39;</span><span class="op">));</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Type uint8_t value in hex format.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>send_byte<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Type uint16_t value in hex format.</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>send_word<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Type uint32_t value in hex format.</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>send_dword<span class="op">(</span>z<span class="op">);</span></span></code></pre></div>
<p>The above example could be reimplemented as:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Type the HSV coordinates for the current RGB matrix color.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>SEND_STRING<span class="op">(</span><span class="st">&quot;HSV: &quot;</span><span class="op">);</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>send_string<span class="op">(</span>get_u8_str<span class="op">(</span>rgb_matrix_get_hue<span class="op">(),</span> <span class="ch">&#39; &#39;</span><span class="op">));</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>SEND_STRING<span class="op">(</span><span class="st">&quot;, &quot;</span><span class="op">);</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>send_string<span class="op">(</span>get_u8_str<span class="op">(</span>rgb_matrix_get_sat<span class="op">(),</span> <span class="ch">&#39; &#39;</span><span class="op">));</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>SEND_STRING<span class="op">(</span><span class="st">&quot;, &quot;</span><span class="op">);</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>send_string<span class="op">(</span>get_u8_str<span class="op">(</span>rgb_matrix_get_val<span class="op">(),</span> <span class="ch">&#39; &#39;</span><span class="op">));</span></span></code></pre></div>
<h3 id="logging-keycodes">Logging keycodes</h3>
<p>A simple way to log keycodes is numerically as hex values:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dprintf<span class="op">(</span><span class="st">&quot;kc=0x</span><span class="sc">%04X\n</span><span class="st">&quot;</span><span class="op">,</span> keycode<span class="op">);</span></span></code></pre></div>
<p>From there, you may look up a numerical code in <a
href="https://github.com/qmk/qmk_firmware/blob/master/quantum/keycodes.h">quantum/keycodes.h</a>
to determine its meaning. However, this process is manual and tiresome,
especially for compound keycodes like tap-hold keys.</p>
<p>Use my <a href="../keycode-string/index.html">keycode_string
function</a> for prettier keycode logging:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dprintf<span class="op">(</span><span class="st">&quot;kc=</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> keycode_string<span class="op">(</span>keycode<span class="op">));</span></span></code></pre></div>
<p>This logs the keycode as a human-readable string like
“<code>LT(2,KC_D)</code>” rather than a hex code like
“<code>0x4207</code>.” See the <a
href="../keycode-string/index.html">keycode_string documentation</a> for
further details.</p>
<h3 id="corresponding-physical-keys-to-matrix-positions">Corresponding
physical keys to matrix positions</h3>
<p>We look at corresponding physical keys to <a
href="../glossary/index.html#matrix-circuit">matrix positions</a> to
demonstrate the above debug messaging techniques.</p>
<p>Each key has a <em>key position</em>, a row and column in the matrix
circuit. Given the <code>keyrecord_t</code> for an event, the key
position that generated the event is under <code>.event.key.row</code>,
<code>.event.key.col</code>. The size of the matrix is
<code>MATRIX_ROWS</code> and <code>MATRIX_COLS</code>, which is often
defined in config.h under the keyboard folder.</p>
<p>The correspondence between physical keys and the matrix is not always
obvious. One way to uncover it is by looking up the definition of the
“<code>LAYOUT</code>” macro for the keyboard, in which the arg names are
often named like “<code>K</code><em>rowcol</em>.” For example, the
Auorora65 keyboard has the following <code>LAYOUT</code> macro (from <a
href="https://github.com/qmk/qmk_firmware/blob/master/keyboards/aurora65/aurora65.h">keyboards/aurora65/aurora65.h</a>):</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode .c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LAYOUT_65_ansi_blocker</span><span class="op">(</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="pp">K00</span><span class="op">,</span><span class="pp"> K01</span><span class="op">,</span><span class="pp"> K02</span><span class="op">,</span><span class="pp"> K03</span><span class="op">,</span><span class="pp"> K04</span><span class="op">,</span><span class="pp"> K05</span><span class="op">,</span><span class="pp"> K06</span><span class="op">,</span><span class="pp"> K07</span><span class="op">,</span><span class="pp"> K08</span><span class="op">,</span><span class="pp"> K09</span><span class="op">,</span><span class="pp"> K0A</span><span class="op">,</span><span class="pp"> K0B</span><span class="op">,</span><span class="pp"> K0C</span><span class="op">,</span><span class="pp"> K0D</span><span class="op">,</span><span class="pp"> K0E</span><span class="op">,\</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="pp">K10</span><span class="op">,</span><span class="pp"> K11</span><span class="op">,</span><span class="pp"> K12</span><span class="op">,</span><span class="pp"> K13</span><span class="op">,</span><span class="pp"> K14</span><span class="op">,</span><span class="pp"> K15</span><span class="op">,</span><span class="pp"> K16</span><span class="op">,</span><span class="pp"> K17</span><span class="op">,</span><span class="pp"> K18</span><span class="op">,</span><span class="pp"> K19</span><span class="op">,</span><span class="pp"> K1A</span><span class="op">,</span><span class="pp"> K1B</span><span class="op">,</span><span class="pp"> K1C</span><span class="op">,</span><span class="pp"> K2C</span><span class="op">,</span><span class="pp"> K1E</span><span class="op">,\</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="pp">K20</span><span class="op">,</span><span class="pp"> K21</span><span class="op">,</span><span class="pp"> K22</span><span class="op">,</span><span class="pp"> K23</span><span class="op">,</span><span class="pp"> K24</span><span class="op">,</span><span class="pp"> K25</span><span class="op">,</span><span class="pp"> K26</span><span class="op">,</span><span class="pp"> K27</span><span class="op">,</span><span class="pp"> K28</span><span class="op">,</span><span class="pp"> K29</span><span class="op">,</span><span class="pp"> K2A</span><span class="op">,</span><span class="pp"> K2B</span><span class="op">,</span><span class="pp">      K2D</span><span class="op">,</span><span class="pp"> K2E</span><span class="op">,\</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="pp">K30</span><span class="op">,</span><span class="pp">      K32</span><span class="op">,</span><span class="pp"> K33</span><span class="op">,</span><span class="pp"> K34</span><span class="op">,</span><span class="pp"> K35</span><span class="op">,</span><span class="pp"> K36</span><span class="op">,</span><span class="pp"> K37</span><span class="op">,</span><span class="pp"> K38</span><span class="op">,</span><span class="pp"> K39</span><span class="op">,</span><span class="pp"> K3A</span><span class="op">,</span><span class="pp"> K3B</span><span class="op">,</span><span class="pp"> K3C</span><span class="op">,</span><span class="pp"> K3D</span><span class="op">,</span><span class="pp"> K3E</span><span class="op">,\</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="pp">K40</span><span class="op">,</span><span class="pp"> K41</span><span class="op">,</span><span class="pp"> K42</span><span class="op">,</span><span class="pp">                K46</span><span class="op">,</span><span class="pp">                K49</span><span class="op">,</span><span class="pp"> K4B</span><span class="op">,</span><span class="pp"> K4C</span><span class="op">,</span><span class="pp"> K4D</span><span class="op">,</span><span class="pp"> K4E </span><span class="op">\</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<p>Below is a graphical representation. Note the unused matrix positions
and irregularities around wide keys:</p>
<p><img src="aurora65-matrix.svg" /></p>
<p>Split keyboards define a matrix in which the first <em>N</em> rows
are the left hand and the following <em>N</em> rows are the right hand.
Thumb clusters can get complicated. Here is the 10×6 matrix for the
Charybdis:</p>
<p><img src="charybdis-matrix.svg" /></p>
<p>One way to work out the matrix correspondence is to print matrix
positions to the debug console (see also <a
href="https://docs.qmk.fm/faq_debug#which-matrix-position-is-this-keypress">Which
matrix position is this keypress?</a>). Enable Console as described
above and add in <code>process_record_user()</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_record_user<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t <span class="op">*</span>record<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>record<span class="op">-&gt;</span>event<span class="op">.</span>pressed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// On every key press, print the event&#39;s keycode and matrix position.</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    dprintf<span class="op">(</span><span class="st">&quot;kc=0x</span><span class="sc">%04X</span><span class="st">, row=</span><span class="sc">%2u</span><span class="st">, col=</span><span class="sc">%2u\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        keycode<span class="op">,</span> record<span class="op">-&gt;</span>event<span class="op">.</span>key<span class="op">.</span>row<span class="op">,</span> record<span class="op">-&gt;</span>event<span class="op">.</span>key<span class="op">.</span>col<span class="op">);</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Alternatively, here is another way that works without Console. In
keymap.c, add a custom keycode <code>INSPECT</code>, use it somewhere in
your layout, and add a handler for it in
<code>process_record_user()</code> as follows:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> custom_keycodes <span class="op">{</span> INSPECT <span class="op">=</span> SAFE_RANGE<span class="op">,</span> <span class="co">/* ... */</span> <span class="op">};</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Use INSPECT in your layout...</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> process_record_user<span class="op">(</span><span class="dt">uint16_t</span> keycode<span class="op">,</span> keyrecord_t<span class="op">*</span> record<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>record<span class="op">-&gt;</span>event<span class="op">.</span>pressed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> <span class="dt">uint16_t</span> prev_keycode <span class="op">=</span> KC_NO<span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> keypos_t prev_pos <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>keycode <span class="op">==</span> INSPECT<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>      SEND_STRING<span class="op">(</span><span class="st">&quot;kc=0x&quot;</span><span class="op">);</span>  <span class="co">// Print info about the previous key.</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>      send_word<span class="op">(</span>prev_keycode<span class="op">);</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      SEND_STRING<span class="op">(</span><span class="st">&quot;, row=&quot;</span><span class="op">);</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      send_string<span class="op">(</span>get_u8_str<span class="op">(</span>prev_pos<span class="op">.</span>row<span class="op">,</span> <span class="ch">&#39; &#39;</span><span class="op">));</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>      SEND_STRING<span class="op">(</span><span class="st">&quot;, col=&quot;</span><span class="op">);</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>      send_string<span class="op">(</span>get_u8_str<span class="op">(</span>prev_pos<span class="op">.</span>col<span class="op">,</span> <span class="ch">&#39; &#39;</span><span class="op">));</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    prev_keycode <span class="op">=</span> keycode<span class="op">;</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    prev_pos <span class="op">=</span> record<span class="op">-&gt;</span>event<span class="op">.</span>key<span class="op">;</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>INSPECT</code> key types out the keycode and position of
the previous key. Tapping for instance the <kbd>W</kbd> key and then
<code>INSPECT</code> prints out</p>
<pre><code>kc=0x001a, row=  1, col=  2</code></pre>
<h2 id="closing">Closing</h2>
<p>Do you need help getting something to work? Do you have a custom QMK
feature or an idea for one that you want to share? Reach out on the <a
href="https://reddit.com/r/olkb">r/olkb subreddit</a> or <a
href="https://discord.gg/Uq7gcHh">Discord</a>.</p>
<p><a href="../index.html">← More about keyboards</a></p>
</div>

<div id="footer">
<p style="text-align:right">
<a href="https://scholar.google.com/citations?user=G8Yjd9AAAAAJ" target="_blank">Google Scholar</a>
<a href="http://www.linkedin.com/in/pascalgetreuer" target="_blank">LinkedIn</a>
</p>
</div>
</body>
</html>
